---
title: "Get data"
author: "Tom Conway"
format: 
  gfm: default
  html:
    embed-resources: true
editor: visual
---

## Get data

### Get data from FPL API and structure into separate files.

NEED TO COME BACK TO THIS AND SAVE DATA EXPLICITLY AS CSVs SO THAT THE OTHER QUARTO DOCS CAN RENDER THEM.

```{r}
#| label: set-up
#| include: false

#Set up libraries required

library(httr)
library(jsonlite)
library(tidyverse)

```

Get data from FPL API - keep separate so don't re-run it.

```{r}
#| label: fpl-api


url <- "https://fantasy.premierleague.com/api/bootstrap-static/"
response <- GET(url)

fpl_data <- fromJSON(content(response, "text"))

```

Next - take out the different tables and give good names. Make the data frames into

```{r}
#| label: split-fpl-data



# Chips - gives chips with names, quantity, start and end, and chip types
# Data structure is almost normal, but lots associated with the assistant manager chip is not.
# Add assistant manager to the list of things to work out later.
fpl_chips <- tibble(fpl_data$chips)

# Events - gives details of each game week.
# Key columns appear to be the deadline, whether the week has passed, is current, or is next, 
# and details of which players have been most chosen or transferred in.

fpl_events <- tibble(fpl_data$events)

# Game_settings - a list containing the parameters for the game. 
# Can capture as might be helpful to reference these if things change in different seasons (e.g. squad value)

fpl_game_settings <- fpl_data$game_settings

# Game_config - a further list with some additional rules (broken into other lists).
# Contains useful parameters like the number of points for different events

fpl_game_config <- fpl_data$game_config

# Phases - the different phases that scores get summarised on, with their start and end weeks
# Whole season plus months.

fpl_phases <- tibble(fpl_data$phases)

# Teams - lists teams with a unique code, whether they have played this week, and some indications of their overall strength.

fpl_teams <- tibble(fpl_data$teams)

# Total_players - how many players are currently in the game - updates in real time.

fpl_total_players <- fpl_data$total_players

# Element_stats - a list of the different stats that players have associated with them.
# Each has a display name and a data column name

fpl_element_stats <- tibble(fpl_data$element_stats)

# Element_types - a list of the 4 different player types, plus managers, and their attributes.

fpl_element_types <- tibble(fpl_data$element_types)

# Elements - the big table of players - have as a tibble. Over 100 variables about each player. This will be the key source of data.

fpl_elements <- tibble(fpl_data$elements)

```

fpl

-   Find data of results by team - get data from Openfootball API in Github. Openfootball has the full list of scores in table format, but with some errors. It also depends on when someone updates their repository on github, which slows down the process. Can I find a better place to get live premier league scores from?

```{r}
#| label: openfootball-api

url2 <- "https://raw.githubusercontent.com/openfootball/football.json/refs/heads/master/2024-25/en.1.json"
response2 <-GET(url2)

open_football_data <- fromJSON(content(response2,"text"))

open_football_data_2 <- open_football_data$matches |>
  unnest_wider(score, names_sep = "_")|>
  unnest_wider(score_ht, names_sep = "_")|>
  unnest_wider(score_ht_1, names_sep = "_")|>
  unnest_wider(score_ft, names_sep = "_")|>
  unnest_wider(score_ft_1, names_sep = "_")

# Also get data from the earlier years

open_football_year <- function(url) {
  response <- GET(url)
  open_football_data <- fromJSON(content(response,"text"))
  open_football_data <- open_football_data$matches |>
  unnest_wider(score, names_sep = "_")|>
  unnest_wider(score_ht, names_sep = "_")|>
  unnest_wider(score_ht_1, names_sep = "_")|>
  unnest_wider(score_ft, names_sep = "_")|>
  unnest_wider(score_ft_1, names_sep = "_")
  open_football_data
}

open_football_2023_24 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2023-24/en.1.json")
open_football_2022_23 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2022-23/en.1.json")
open_football_2021_22 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2021-22/en.1.json")

# and also championship data for information on promoted teams

open_football_championship_2024_25 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2024-25/en.2.json")
open_football_championship_2023_24 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2023-24/en.2.json")
open_football_championship_2022_23 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2022-23/en.2.json")
open_football_championship_2021_22 <- open_football_year("https://github.com/openfootball/football.json/raw/refs/heads/master/2021-22/en.2.json")
```

-   Openfootball seems unreliable - here is another JSON API from fixturedownload.com

```{r}
#| label: fixture-download-feed

url3 <- "https://fixturedownload.com/feed/json/epl-2024"
response3 <- GET(url3)

fixture_download_data <- tibble(fromJSON(content(response3, "text")))

```

-   Should I be thinking about web scraping instead? I assume the premier league wants this to be difficult so they can charge people for live scores.

-   Other team or player data?

-   Projections to bring in?

### Noting later data cleaning tasks

-   Deadline date needs to be in a time format

-   
